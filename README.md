# codegen

A versatile Go code generation tool that provides:
- **Mock generation** from Go interfaces with full generics support
- **Interface generation** from Go structs for clean architecture patterns

## Installation

```bash
# Install globally
go get github.com/kmio11/codegen

# Or clone and build locally
git clone https://github.com/kmio11/codegen
cd codegen
go build .
```

## Quick Start

### Interface Generation from Structs

Generate interfaces from existing struct methods:

```go
// math.go
type Calculator struct{}

func (c *Calculator) Add(a, b int) int {
    return a + b
}

func (c *Calculator) Subtract(a, b int) int {
    return a - b
}

func (c *Calculator) Multiply(a, b int) int {
    return a * b
}

func (c *Calculator) Divide(a, b int) (int, error) {
    if b == 0 {
        return 0, nil
    }
    return a / b, nil
}
```

Generate interface:
```bash
go run github.com/kmio11/codegen interface -pkg . -type Calculator -out calculator_interface_gen.go
```

This generates:
```go
// Code generated by "interface"; DO NOT EDIT.
package main

type CalculatorInterface interface {
    Add(a, b int) int
    Subtract(a, b int) int
    Multiply(a, b int) int
    Divide(a, b int) (int, error)
}
```

### Basic Interface Mocking

Given an interface:
```go
// calculator.go
type Calculator interface {
    Add(a, b int) int
    Subtract(a, b int) int
    Multiply(a, b int) int
    Divide(a, b int) (int, error)
}
```

Generate mocks:
```bash
go run github.com/kmio11/codegen mock -pkg . -type Calculator -out calculator_mock_gen.go
```

This generates two types of mock structures:

**Mock struct (with function fields for direct control):**
```go
type MockCalculator struct {
    Calculator
    FakeAdd      func(a, b int) int
    FakeSubtract func(a, b int) int
    FakeMultiply func(a, b int) int
    FakeDivide   func(a, b int) (int, error)
}
```

**Stub struct (convenient for testing):**
```go
type StubCalculator struct {
    Add      StubAdd
    Subtract StubSubtract
    Multiply StubMultiply
    Divide   StubDivide
}

func (s StubCalculator) NewMock() Calculator {
    return &MockCalculator{
        FakeAdd:      func(a0, a1 int) int { return s.Add.R0 },
        FakeSubtract: func(a0, a1 int) int { return s.Subtract.R0 },
        FakeMultiply: func(a0, a1 int) int { return s.Multiply.R0 },
        FakeDivide:   func(a0, a1 int) (int, error) { return s.Divide.R0, s.Divide.R1 },
    }
}
```

### Generic Interface Mocking

For generic interfaces:
```go
// calculator.go
type Storage[K comparable, V any] interface {
    Set(key K, value V)
    Get(key K) (V, bool)
    Delete(key K)
    List() []K
}
```

Generate with type parameters:
```bash
go run github.com/kmio11/codegen mock -pkg . -type Storage -out storage_mock_gen.go
```

## Usage Examples

### Direct Mock Usage
```go
func TestCalculator_Direct(t *testing.T) {
    mock := &MockCalculator{
        FakeAdd: func(a, b int) int {
            return a + b
        },
        FakeDivide: func(a, b int) (int, error) {
            if b == 0 {
                return 0, errors.New("division by zero")
            }
            return a / b, nil
        },
    }
    
    result := mock.Add(5, 3)
    if result != 8 {
        t.Errorf("Expected 8, got %d", result)
    }
}
```

### Stub-Based Testing (Recommended)
```go
func TestCalculator_Stub(t *testing.T) {
    stub := StubCalculator{
        Add:      StubAdd{R0: 15},
        Subtract: StubSubtract{R0: 5},
        Multiply: StubMultiply{R0: 50},
        Divide:   StubDivide{R0: 2, R1: nil},
    }
    
    calc := stub.NewMock()
    
    if result := calc.Add(10, 5); result != 15 {
        t.Errorf("Expected 15, got %d", result)
    }
}
```

### Generic Mock Usage
```go
func TestStorage_Generic(t *testing.T) {
    // Create mock for Storage[string, int]
    stub := StubStorage[string, int]{
        Get: StubGet[string, int]{
            R0: 42,
            R1: true,
        },
    }
    
    storage := stub.NewMock()
    
    value, found := storage.Get("key")
    if !found {
        t.Error("Expected key to be found")
    }
    if value != 42 {
        t.Errorf("Expected 42, got %d", value)
    }
}
```

## Command Reference

### Interface Command

Generate interfaces from struct methods:

```bash
go run github.com/kmio11/codegen interface [options]
```

**Required Options:**
- `-pkg <package>` - Target package path containing the struct
- `-type <struct>` - Struct name to generate interface from

**Optional Options:**
- `-out <file>` - Output file path (defaults to stdout)
- `-outpkg <package>` - Output package name (defaults to source package)
- `-selfpkg <path>` - Full package import path for the output package
- `-name <interface>` - Custom interface name (defaults to `<StructName>Interface`)

**Examples:**
```bash
# Basic usage - generates CalculatorInterface
go run . interface -pkg . -type Calculator -out calculator_interface_gen.go

# Custom interface name
go run . interface -pkg . -type Calculator -name MathCalculator -out math_calculator_gen.go

# Different output package
go run . interface -pkg ./math -type Calculator -outpkg contracts -out contracts/calculator_gen.go

# Output to stdout
go run . interface -pkg . -type Logger

# Complex package structure
go run . interface -pkg ./internal/math -type Calculator -selfpkg github.com/myorg/myapp/contracts -outpkg contracts -out contracts/math_gen.go
```

### Mock Command

Generate mocks from interfaces:

```bash
go run github.com/kmio11/codegen mock [options]
```

**Required Options:**
- `-pkg <package>` - Target package path
- `-type <interface>` - Interface name to mock
- `-out <file>` - Output file path

**Optional Options:**
- `-outpkg <package>` - Output package name
- `-selfpkgpath <path>` - Self package path for imports

**Examples:**
```bash
# Basic usage
go run . mock -pkg . -type Calculator -out calculator_mock_gen.go

# With custom output package
go run . mock -pkg ./math -type Calculator -outpkg mocks -out mocks/calculator_gen.go

# Generic interface
go run . mock -pkg . -type "Storage" -out storage_mock_gen.go

# Simple interface  
go run . mock -pkg . -type "Logger" -out logger_mock_gen.go
```

## Features

### Interface Generation
- ✅ **Struct-to-Interface Conversion** - Extract interface definitions from existing struct methods
- ✅ **Export-only Method Extraction** - Only includes public (exported) methods in generated interfaces
- ✅ **Custom Interface Naming** - Flexible naming with sensible defaults
- ✅ **Package Management** - Support for cross-package generation with proper imports
- ✅ **Clean Code Output** - Properly formatted, idiomatic Go interface definitions

### Mock Generation  
- ✅ **Go 1.18+ Generics Support** - Generate mocks for generic interfaces with type parameters and constraints
- ✅ **Dual Mock Strategy** - Creates both Mock structs (function fields) and Stub structs (convenient testing)
- ✅ **Smart Import Management** - Automatic dependency resolution and package import handling
- ✅ **Clean Code Generation** - Produces properly formatted, idiomatic Go code

## Use Cases

### Interface Generation Use Cases
- **API Design** - Define contract interfaces from existing implementations
- **Refactoring** - Create interfaces to break dependencies in legacy code
- **Testing** - Generate interfaces for easier mocking and testing
- **Documentation** - Create clear API contracts from implementation code

### Mock Generation Use Cases
- **Unit Testing** - Create test doubles for interface dependencies
- **Integration Testing** - Mock external dependencies
- **TDD Development** - Generate mocks before implementing real code
- **CI/CD** - Create reliable, fast tests without external dependencies

## Examples

### Interface Generation Examples
The `_examples/interface/` directory contains working examples:

- **`math.go`** - Example structs with various method signatures (Calculator, Logger)

### Mock Generation Examples
The `_examples/mock/` directory contains working examples:

- **`calculator.go`** - Basic and generic interface definitions (Calculator, Storage)
- **`calculator_test.go`** - Demonstrate proper mock usage patterns with both direct and stub approaches

