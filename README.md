# codegen

A versatile Go code generation tool that provides:
- **Mock generation** from Go interfaces with full generics support
- **Interface generation** from Go structs for clean architecture patterns

## Installation

```bash
# Install globally
go get github.com/kmio11/codegen/cmd

# Or clone and build locally
git clone https://github.com/kmio11/codegen
cd codegen
go build ./cmd
```

## Quick Start

### Interface Generation from Structs

Generate interfaces from existing struct methods:

```go
// user_service.go
type UserService struct {
    db Database
}

func (u *UserService) GetUser(id string) (*User, error) {
    return u.db.FindUser(id)
}

func (u *UserService) CreateUser(user *User) error {
    return u.db.SaveUser(user)
}

func (u *UserService) DeleteUser(id string) error {
    return u.db.RemoveUser(id)
}
```

Generate interface:
```bash
go run github.com/kmio11/codegen/cmd interface -pkg . -type UserService -out user_interface.go
```

This generates:
```go
// Code generated by "interface"; DO NOT EDIT.
package main

type UserServiceInterface interface {
    GetUser(id string) (*User, error)
    CreateUser(user *User) error
    DeleteUser(id string) error
}
```

### Basic Interface Mocking

Given an interface:
```go
// user.go
type UserService interface {
    GetUser(id string) (*User, error)
    CreateUser(user *User) error
    DeleteUser(id string) error
}
```

Generate mocks:
```bash
go run github.com/kmio11/codegen/cmd mock -pkg . -type UserService -out user_mock.go
```

This generates two types of mock structures:

**Mock struct (with function fields for direct control):**
```go
type MockUserService struct {
    UserService
    FakeGetUser    func(id string) (*User, error)
    FakeCreateUser func(user *User) error
    FakeDeleteUser func(id string) error
}
```

**Stub struct (convenient for testing):**
```go
type StubUserService struct {
    GetUser    StubGetUser
    CreateUser StubCreateUser
    DeleteUser StubDeleteUser
}

func (s StubUserService) NewMock() UserService {
    return &MockUserService{
        FakeGetUser:    func(a0 string) (*User, error) { return s.GetUser.R0, s.GetUser.R1 },
        FakeCreateUser: func(a0 *User) error { return s.CreateUser.R0 },
        FakeDeleteUser: func(a0 string) error { return s.DeleteUser.R0 },
    }
}
```

### Generic Interface Mocking

For generic interfaces:
```go
// repository.go
type Repository[T any] interface {
    Get(id string) (T, error)
    Save(item T) error
    List() ([]T, error)
}

type Cache[K comparable, V any] interface {
    Set(key K, value V)
    Get(key K) (V, bool)
    Delete(key K)
}
```

Generate with type parameters:
```bash
go run github.com/kmio11/codegen/cmd mock -pkg . -pkg . -type Repository -out repository_mock_gen.go
go run github.com/kmio11/codegen/cmd mock -pkg . -type "Cache" -out cache_mock_gen.go
```

## Usage Examples

### Direct Mock Usage
```go
func TestUserService_Direct(t *testing.T) {
    mock := &MockUserService{
        FakeGetUser: func(id string) (*User, error) {
            if id == "123" {
                return &User{ID: "123", Name: "John"}, nil
            }
            return nil, errors.New("user not found")
        },
    }
    
    user, err := mock.GetUser("123")
    assert.NoError(t, err)
    assert.Equal(t, "John", user.Name)
}
```

### Stub-Based Testing (Recommended)
```go
func TestUserService_Stub(t *testing.T) {
    stub := StubUserService{
        GetUser: StubGetUser{
            R0: &User{ID: "123", Name: "John"},
            R1: nil,
        },
        CreateUser: StubCreateUser{R0: nil},
    }
    
    userService := stub.NewMock()
    
    user, err := userService.GetUser("123")
    assert.NoError(t, err)
    assert.Equal(t, "John", user.Name)
}
```

### Generic Mock Usage
```go
func TestRepository_Generic(t *testing.T) {
    // Create mock for Repository[string]
    stub := StubRepository[string]{
        Get: StubGet[string]{
            R0: "test-item",
            R1: nil,
        },
        Save: StubSave[string]{R0: nil},
    }
    
    repo := stub.NewMock()
    
    item, err := repo.Get("key")
    assert.NoError(t, err)
    assert.Equal(t, "test-item", item)
}
```

## Command Reference

### Interface Command

Generate interfaces from struct methods:

```bash
go run github.com/kmio11/codegen/cmd interface [options]
```

**Required Options:**
- `-pkg <package>` - Target package path containing the struct
- `-type <struct>` - Struct name to generate interface from

**Optional Options:**
- `-out <file>` - Output file path (defaults to stdout)
- `-outpkg <package>` - Output package name (defaults to source package)
- `-selfpkg <path>` - Full package import path for the output package
- `-name <interface>` - Custom interface name (defaults to `<StructName>Interface`)

**Examples:**
```bash
# Basic usage - generates UserServiceInterface
go run ./cmd interface -pkg . -type UserService -out user_interface.go

# Custom interface name
go run ./cmd interface -pkg . -type UserService -name UserRepository -out user_repo.go

# Different output package
go run ./cmd interface -pkg ./services -type PaymentService -outpkg contracts -out contracts/payment.go

# Output to stdout
go run ./cmd interface -pkg . -type AuthService

# Complex package structure
go run ./cmd interface -pkg ./internal/service -type OrderProcessor -selfpkg github.com/myorg/myapp/contracts -outpkg contracts -out contracts/order.go
```

### Mock Command

Generate mocks from interfaces:

```bash
go run github.com/kmio11/codegen/cmd mock [options]
```

**Required Options:**
- `-pkg <package>` - Target package path
- `-type <interface>` - Interface name to mock
- `-out <file>` - Output file path

**Optional Options:**
- `-outpkg <package>` - Output package name
- `-selfpkgpath <path>` - Self package path for imports

**Examples:**
```bash
# Basic usage
go run ./cmd mock -pkg . -type UserService -out user_mock.go

# With custom output package
go run ./cmd mock -pkg ./services -type PaymentService -outpkg mocks -out mocks/payment_mock.go

# Generic interface
go run ./cmd mock -pkg . -type "Repository[T any]" -out repository_mock.go

# Interface with complex constraints  
go run ./cmd mock -pkg . -type "Processor[T comparable, U int|float64]" -out processor_mock.go
```

## Features

### Interface Generation
- ✅ **Struct-to-Interface Conversion** - Extract interface definitions from existing struct methods
- ✅ **Export-only Method Extraction** - Only includes public (exported) methods in generated interfaces
- ✅ **Custom Interface Naming** - Flexible naming with sensible defaults
- ✅ **Package Management** - Support for cross-package generation with proper imports
- ✅ **Clean Code Output** - Properly formatted, idiomatic Go interface definitions

### Mock Generation  
- ✅ **Go 1.18+ Generics Support** - Generate mocks for generic interfaces with type parameters and constraints
- ✅ **Dual Mock Strategy** - Creates both Mock structs (function fields) and Stub structs (convenient testing)
- ✅ **Smart Import Management** - Automatic dependency resolution and package import handling
- ✅ **Clean Code Generation** - Produces properly formatted, idiomatic Go code

## Use Cases

### Interface Generation Use Cases
- **Clean Architecture** - Extract interfaces from concrete implementations for dependency inversion
- **API Design** - Define contract interfaces from existing service implementations
- **Refactoring** - Create interfaces to break dependencies in legacy code
- **Testing** - Generate interfaces for easier mocking and testing
- **Documentation** - Create clear API contracts from implementation code

### Mock Generation Use Cases
- **Unit Testing** - Create test doubles for interface dependencies
- **Integration Testing** - Mock external services and dependencies
- **TDD Development** - Generate mocks before implementing real services
- **CI/CD** - Create reliable, fast tests without external dependencies

## Examples

### Interface Generation Examples
The `cmd/interface/_sample/` directory contains working examples:

- **`sample.go`** - Example struct with various method signatures
- **`integration_test.go`** - End-to-end testing examples
- **Generated interface files** - Show expected interface output format

### Mock Generation Examples
The `cmd/mock/_sample/` directory contains working examples:

- **`sample.go`** - Basic interface definitions
- **`generic_interfaces.go`** - Generic interface examples with various constraints
- **`*_test.go`** files - Demonstrate proper mock usage patterns
- **Generated mock files** - Show expected output format

## Workflow Integration

### Clean Architecture Pattern
```bash
# 1. Start with concrete implementation
# user_service.go contains UserService struct with methods

# 2. Generate interface contract
go run ./cmd interface -pkg . -type UserService -name UserRepository -out user_repository.go

# 3. Generate mocks for testing
go run ./cmd mock -pkg . -type UserRepository -out user_repository_mock.go

# 4. Use in dependency injection
```

### TDD Workflow
```bash
# 1. Define interface first
# user_repository.go contains UserRepository interface

# 2. Generate mocks for testing
go run ./cmd mock -pkg . -type UserRepository -out user_repository_mock.go

# 3. Write tests using mocks
# 4. Implement concrete struct
# 5. Generate interface from struct to verify contract compliance
go run ./cmd interface -pkg . -type UserService -name UserRepository
```